YUI.add("moodle-atto_imagedragdrop-button",function(e,t){var n="atto_imagedragdrop",r='<img src="{{url}}" alt="{{alt}}" {{#if id}}id="{{id}}" {{/if}}/>';e.namespace("M.atto_imagedragdrop").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{_currentSelection:null,initializer:function(){var t=this,i=this.get("host"),s=e.Handlebars.compile(r);this.editor.on("drop",function(r){i.saveSelection(),r=r._event;if(r.dataTransfer&&r.dataTransfer.files&&r.dataTransfer.files.length&&/^image\//.test(r.dataTransfer.files[0].type)){r.preventDefault(),r.stopPropagation();var o=i.get("filepickeroptions").image,u=new FormData;u.append("repo_upload_file",r.dataTransfer.files[0]),u.append("itemid",o.itemid);var a=0;for(;;){if(o.repositories[++a]===undefined)break;if(o.repositories[a].type==="upload"){u.append("repo_id",o.repositories[a].id);break}}u.append("env",o.env),u.append("sesskey",M.cfg.sesskey),u.append("client_id",o.client_id),u.append("savepath",o.savepath),u.append("ctx_id",o.context.id);var f=(new Date).getTime(),l="moodleimage_"+Math.round(Math.random()*1e5)+"-"+f;i.focus(),i.restoreSelection();var c=s({url:M.util.image_url("i/loading_small","moodle"),alt:M.util.get_string("uploading",n),id:l});i.insertContentAtFocusPoint(c),t.markUpdated();var h=new XMLHttpRequest;return h.onreadystatechange=function(){if(h.readyState===4){var n=t.editor.one("#"+l);if(h.status===200){var r=JSON.parse(h.responseText);if(r){if(r.error)return n&&n.remove(!0),new M.core.ajaxException(r);var i=r;r.event&&r.event==="fileexists"&&(i=r.newfile);var o=i.filename||i.file,u=s({url:i.url,alt:o}),a=e.Node.create(u);n?n.replace(a):t.editor.appendChild(a),t.markUpdated()}}else alert(M.util.get_string("servererror","moodle")),n&&n.remove(!0)}},h.open("POST",M.cfg.wwwroot+"/repository/repository_ajax.php?action=upload",!0),h.send(u),!1}},this)}})},"@VERSION@",{requires:["moodle-editor_atto-plugin","node","escape"]});
