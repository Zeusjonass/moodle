YUI.add("moodle-atto_imagedragdrop-button",function(e,t){var n="atto_imagedragdrop",r='<img src="{{url}}" alt="{{alt}}" {{#if id}}id="{{id}}" {{/if}}/>';e.namespace("M.atto_imagedragdrop").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{_currentSelection:null,initializer:function(){var t=this,i=this.get("host"),s=e.Handlebars.compile(r);this.editor.on("drop",function(r){i.saveSelection(),r=r._event;if(r.dataTransfer&&r.dataTransfer.files&&r.dataTransfer.files.length&&/^image\//.test(r.dataTransfer.files[0].type)){r.preventDefault(),r.stopPropagation();var o=i.get("filepickeroptions").image,u=o.savepath===undefined?"/":o.savepath,a=new FormData;a.append("repo_upload_file",r.dataTransfer.files[0]),a.append("itemid",o.itemid);var f=0;for(;;){if(o.repositories[++f]===undefined)break;if(o.repositories[f].type==="upload"){a.append("repo_id",o.repositories[f].id);break}}a.append("env",o.env),a.append("sesskey",M.cfg.sesskey),a.append("client_id",o.client_id),a.append("savepath",u),a.append("ctx_id",o.context.id);var l=(new Date).getTime(),c="moodleimage_"+Math.round(Math.random()*1e5)+"-"+l;i.focus(),i.restoreSelection();var h=s({url:M.util.image_url("i/loading_small","moodle"),alt:M.util.get_string("uploading",n),id:c});i.insertContentAtFocusPoint(h),t.markUpdated();var p=new XMLHttpRequest;return p.onreadystatechange=function(){if(p.readyState===4){var n=t.editor.one("#"+c);if(p.status===200){var r=JSON.parse(p.responseText);if(r){if(r.error)return n&&n.remove(!0),new M.core.ajaxException(r);var i=r;r.event&&r.event==="fileexists"&&(i=r.newfile);var o=i.filename||i.file,u=s({url:i.url,alt:o}),a=e.Node.create(u);n?n.replace(a):t.editor.appendChild(a),t.markUpdated()}}else alert(M.util.get_string("servererror","moodle")),n&&n.remove(!0)}},p.open("POST",M.cfg.wwwroot+"/repository/repository_ajax.php?action=upload",!0),p.send(a),!1}},this)}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});
